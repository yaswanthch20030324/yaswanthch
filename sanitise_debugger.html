<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sanitise Redirect Debugger</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem;
    }
    input, textarea, button {
      font-size: 1rem;
      margin: 0.5rem 0;
      padding: 0.4rem;
      width: 100%;
      box-sizing: border-box;
    }
    pre {
      background: #f5f5f5;
      padding: 1rem;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h2>ðŸ§¹ Frappe Sanitise Redirect Debugger</h2>

  <label>Enter a URL to test:</label>
  <input id="inputUrl" placeholder="e.g. https://example.com or javascript:alert(1)" />

  <button onclick="runSanitise()">Sanitise URL</button>

  <h3>Output:</h3>
  <pre id="output"></pre>

  <script>
    // --- mock frappe.utils namespace ---
    const frappe = { utils: {} };

    // Strip leading/trailing spaces
    frappe.utils.strip_url = (url) => (url || "").trim();

    // --- Frappe sanitise_redirect logic ---
    frappe.utils.sanitise_redirect = (url) => {
      const is_external = (() => {
        return (url) => {
          function domain(url) {
            let base_domain =
              /^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:/\n?]+)/gim.exec(url);
            return base_domain == null ? "" : base_domain[1];
          }

          function is_absolute(url) {
            return /^(?:[a-z]+:)?\/\//i.test(url);
          }

          return is_absolute(url) ? domain(location.href) !== domain(url) : false;
        };
      })();

      // --- sanitise_javascript ---
      const sanitise_javascript = (url) => {
        const REGEX_ESC_UNIT = /\s*(&#x.{1,7})?/;
        const REGEX_SCRIPT = new RegExp(
          Array.from("javascript").join(REGEX_ESC_UNIT.source),
          "gi"
        );
        return url.replace(REGEX_SCRIPT, "");
      };

      url = frappe.utils.strip_url(url);

      return is_external(url)
        ? ""
        : sanitise_javascript(
            frappe.utils.xss_sanitise(url, { strategies: ["js"] })
          );
    };

    // --- xss_sanitise logic ---
    frappe.utils.xss_sanitise = function (string, options) {
      let sanitised = string;
      const DEFAULT_OPTIONS = { strategies: ["html", "js"] };
      const HTML_ESCAPE_MAP = {
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#x27;",
        "/": "&#x2F;",
      };
      const REGEX_SCRIPT = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;
      const REGEX_ALERT = /confirm\(.*\)|alert\(.*\)|prompt\(.*\)/gi;

      options = Object.assign({}, DEFAULT_OPTIONS, options);

      if (options.strategies.includes("js")) {
        sanitised = sanitised.replace(REGEX_SCRIPT, "");
        sanitised = sanitised.replace(REGEX_ALERT, "");
      }

      if (options.strategies.includes("html")) {
        for (let char in HTML_ESCAPE_MAP) {
          const escape = HTML_ESCAPE_MAP[char];
          const regex = new RegExp(char, "g");
          sanitised = sanitised.replace(regex, escape);
        }
      }

      return sanitised;
    };

    // --- run sanitisation ---
    function runSanitise() {
      const input = document.getElementById("inputUrl").value;
      const result = frappe.utils.sanitise_redirect(input);
      document.getElementById("output").textContent =
        `Input:  ${input}\n` +
        `Output: ${result}\n` +
        `Note: empty string ("") means the URL was considered external.`;
    }
  </script>
</body>
</html>

